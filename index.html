<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="theme-color" content="#050816">
    <title>LAGmate â€” Mastering English Fluency</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root { 
            --blue: #4cc9f0; 
            --purple: #9b5de5; 
            --dark: #02040a; 
            --glass: rgba(255, 255, 255, 0.02);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f8f9ff;
            --text-dim: #cbd5e1;
            --accent-gradient: linear-gradient(135deg, #4cc9f0 0%, #9b5de5 100%);
        }

        /* --- GLOBAL RESET --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            height: 100vh;
            background: var(--dark);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(76, 201, 240, 0.12) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(155, 93, 229, 0.12) 0%, transparent 40%);
            color: var(--text-main);
            font-family: 'Plus Jakarta Sans', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 15px;
            overflow: hidden; 
        }

        /* --- WRAPPER --- */
        .app-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-height: 100%;
            overflow-y: auto; 
            padding-bottom: 20px;
            position: relative;
        }

        /* --- SETTINGS BUTTON (Top Right) --- */
        .settings-btn {
            position: absolute;
            top: 5px;
            right: 0;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            color: var(--text-dim);
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
        }
        .settings-btn:hover { background: rgba(76, 201, 240, 0.2); color: #fff; }
        .settings-btn svg { width: 20px; height: 20px; fill: currentColor; }

        /* --- LOGIN / SETTINGS MODAL --- */
        .prompt-modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 90%; max-width: 350px;
            background: linear-gradient(160deg, #0a0f1e 0%, #02040a 100%);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            z-index: 10000;
            box-shadow: 0 0 50px rgba(0,0,0,0.9);
            display: none;
        }
        .prompt-modal.active { display: block; animation: fadeIn 0.3s ease; }
        
        .modal-title { font-family:'Orbitron'; color:#fff; margin:0 0 20px 0; font-size:16px; letter-spacing: 1px; text-align: center; }
        
        .modal-input {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: #fff;
            padding: 12px;
            font-size: 13px;
            margin-bottom: 15px;
            font-family: inherit;
        }
        .modal-input:focus { border-color: var(--blue); }

        textarea.modal-input { height: 120px; resize: none; line-height: 1.4; }

        /* --- WELCOME MODAL --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(15px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            transition: 0.5s;
        }
        .modal-overlay.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .modal-content {
            background: linear-gradient(160deg, #0a0f1e 0%, #02040a 100%);
            border: 1px solid var(--glass-border);
            max-width: 450px;
            width: 100%;
            border-radius: 30px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 0 60px rgba(76, 201, 240, 0.15);
        }

        .btn-close {
            background: var(--accent-gradient);
            border: none;
            padding: 12px 35px;
            border-radius: 100px;
            color: #000;
            font-family: 'Orbitron';
            font-weight: 900;
            cursor: pointer;
            font-size: 12px;
        }

        /* --- BRANDING & UI --- */
        .brand-header { text-align: center; margin-bottom: 10px; flex-shrink: 0; width: 100%; position: relative; min-height: 40px; }
        h1 {
            font-family: 'Orbitron';
            letter-spacing: 6px;
            margin: 0;
            font-size: 32px;
            font-weight: 900;
            padding-top: 5px;
        }
        .brand-lag { color: var(--blue); }
        .brand-mate { color: var(--purple); text-transform: lowercase; }

        .motto-container { margin-bottom: 15px; text-align: center; flex-shrink: 0; }
        .motto-text { font-size: 12px; color: var(--text-dim); font-style: italic; opacity: 0.8; }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
            max-width: 400px;
            margin-bottom: 15px;
            flex-shrink: 0;
        }
        .stat-card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            padding: 10px;
            border-radius: 15px;
            text-align: center;
        }
        .stat-label { font-size: 9px; text-transform: uppercase; color: #6b7280; margin-bottom: 2px; }
        .stat-value { font-family: 'Orbitron'; font-size: 11px; color: var(--blue); }

        .orb-wrapper { margin-bottom: 15px; flex-shrink: 0; }
        .orb {
            width: 120px; height: 120px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff 0%, var(--blue) 20%, var(--purple) 60%, var(--dark) 100%);
            box-shadow: 0 0 40px rgba(76, 201, 240, 0.2);
            transition: 0.5s;
        }

        .transcript-container {
            width: 100%; max-width: 450px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 15px;
            min-height: 100px;
            max-height: 120px;
            overflow-y: auto;
            flex-shrink: 0;
        }
        .ai-line { font-size: 13.5px; color: var(--text-dim); line-height: 1.5; }
        .user-line { color: var(--blue); text-align: right; margin-top: 10px; font-weight: 600; font-size: 12px; }

        .control-system { width: 100%; max-width: 350px; flex-shrink: 0; }
        
        select {
            background: rgba(255,255,255,0.05);
            color: #fff;
            border: 1px solid var(--glass-border);
            padding: 12px; border-radius: 12px; width: 100%;
            margin-bottom: 15px; font-size: 12px;
            cursor: pointer;
        }
        
        .btn-prime {
            width: 100%; padding: 15px; border-radius: 15px; border: none;
            background: var(--accent-gradient);
            font-family: 'Orbitron'; font-weight: 800; cursor: pointer;
            letter-spacing: 2px; font-size: 13px;
        }

        /* --- FOOTER --- */
        .footer-premium { margin-top: 20px; width: 100%; flex-shrink: 0; }
        .dev-card {
            background: var(--glass); border: 1px solid var(--glass-border);
            padding: 12px; border-radius: 20px; max-width: 350px; margin: 0 auto;
            display: flex; flex-direction: column; align-items: center;
        }
        .dev-name { font-family: 'Orbitron'; color: var(--blue); font-size: 13px; margin: 2px 0; }
        .dev-sub { font-size: 10px; color: #94a3b8; margin-top: 2px; margin-bottom: 5px; }
        
        .social-link {
            margin-top: 5px; padding: 6px 15px;
            background: #1877F2; color: #fff; text-decoration: none;
            border-radius: 50px; font-size: 10px; font-weight: 700;
        }

        /* --- ANIMATIONS --- */
        .listening { animation: breathe 1.5s infinite ease-in-out; border: 2px solid var(--blue); }
        .speaking { animation: pulse 0.8s infinite alternate; border: 2px solid var(--purple); }
        .thinking { filter: grayscale(0.5) contrast(1.2); animation: spin 2s linear infinite; }
        @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -45%); } to { opacity: 1; transform: translate(-50%, -50%); } }

        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes pulse { from { box-shadow: 0 0 20px var(--purple); } to { box-shadow: 0 0 50px var(--blue); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .hidden { display: none !important; }
        .section-hidden { display: none; }

        @media (max-height: 650px) {
            h1 { font-size: 24px; }
            .orb { width: 90px; height: 90px; }
            .transcript-container { min-height: 80px; padding: 10px; }
        }
    </style>
</head>

<body>
    <!-- --- WELCOME MODAL --- -->
    <div class="modal-overlay" id="welcomeModal">
        <div class="modal-content">
            <h2 style="font-family:'Orbitron'; color:var(--blue); margin-bottom:10px;">READY?</h2>
            <p style="color: #cbd5e1; font-size: 13px; margin-bottom: 20px;">
                "Success starts with a conversation."<br>
                Speak freely in English.
            </p>
            <button class="btn-close" id="closeModal">START NOW</button>
        </div>
    </div>

    <!-- --- SECURE ADMIN MODAL --- -->
    <div class="prompt-modal" id="promptModal">
        
        <!-- LOGIN VIEW -->
        <div id="loginSection">
            <h3 class="modal-title" style="color:#ef4444;">RESTRICTED ACCESS</h3>
            <p style="font-size:11px; color:#94a3b8; text-align:center; margin-bottom:15px;">AUTHORIZED PERSONNEL ONLY</p>
            
            <input type="text" class="modal-input" placeholder="Username (Optional)">
            <input type="password" id="adminPassInput" class="modal-input" placeholder="Enter Password">
            
            <button class="btn-prime" id="loginBtn">LOGIN</button>
            <button class="btn-prime" id="cancelBtn" style="background:transparent; border:1px solid #333; margin-top:10px;">CLOSE</button>
        </div>

        <!-- HIDDEN SETTINGS VIEW -->
        <div id="settingsSection" class="section-hidden">
            <h3 class="modal-title" style="color:var(--blue);">SYSTEM CORE</h3>
            <p style="font-size:11px; color:#94a3b8; margin-bottom:10px;">MODIFY AI BEHAVIOR LOGIC:</p>
            
            <textarea id="promptInput" class="modal-input"></textarea>
            
            <button class="btn-prime" id="savePromptBtn">UPDATE SYSTEM</button>
        </div>

    </div>

    <!-- --- APP CONTAINER --- -->
    <div class="app-container">
        <header class="brand-header">
            <h1><span class="brand-lag">LAG</span><span class="brand-mate">mate</span></h1>
            
            <!-- Lock/Login Button -->
            <button class="settings-btn" id="openSettings" title="Admin Login">
                <svg viewBox="0 0 24 24"><path d="M12,17c1.1,0,2-0.9,2-2s-0.9-2-2-2s-2,0.9-2,2S10.9,17,12,17z M18,8h-1V6c0-2.76-2.24-5-5-5S7,3.24,7,6v2H6 c-1.1,0-2,0.9-2,2v10c0,1.1,0.9,2,2,2h12c1.1,0,2-0.9,2-2V10C20,8.9,19.1,8,18,8z M8.9,6c0-1.71,1.39-3.1,3.1-3.1s3.1,1.39,3.1,3.1v2 H8.9V6z M18,20H6V10h12V20z"/></svg>
            </button>
        </header>

        <div class="motto-container">
            <p class="motto-text">"Don't fear mistakes. Speak with confidence."</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-label">Progress</span>
                <span class="stat-value" id="fluencyMeter">WAITING</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Confidence</span>
                <span class="stat-value" id="loadMeter">STEADY</span>
            </div>
        </div>

        <div class="orb-wrapper">
            <div class="orb" id="orb"></div>
        </div>

        <div class="transcript-container" id="transcriptBox">
            <div class="ai-line" id="aiTxt">Hello! I'm your English Tutor. Ready to practice?</div>
            <div class="user-line" id="userTxt"></div>
        </div>

        <div class="control-system" id="uiPanel">
            <select id="micSelect"><option value="">Detecting Mic...</option></select>
            <button class="btn-prime" id="startBtn">START PRACTICE</button>
        </div>

        <footer class="footer-premium">
            <div class="dev-card">
                <div class="dev-name">Developed by Mohammad Miraz Ali</div>
                <div class="dev-sub">EEE Dept, Dhaka University</div>
                <a href="https://www.facebook.com/mohammad.miraz.ali.2025" target="_blank" class="social-link">Facebook Support</a>
            </div>
        </footer>
    </div>

    <script>
        // --- THIS AUTOMATICALLY CONNECTS TO THE SERVER HOSTING THIS FILE ---
        const BACKEND_URL = '/chat'; 
        
        const orb = document.getElementById('orb');
        const aiTxt = document.getElementById('aiTxt');
        const userTxt = document.getElementById('userTxt');
        const startBtn = document.getElementById('startBtn');
        const micSelect = document.getElementById('micSelect');
        const uiPanel = document.getElementById('uiPanel');
        const welcomeModal = document.getElementById('welcomeModal');
        const closeModal = document.getElementById('closeModal');
        const fluencyMeter = document.getElementById('fluencyMeter');
        const transcriptBox = document.getElementById('transcriptBox');

        // Settings Elements
        const openSettings = document.getElementById('openSettings');
        const promptModal = document.getElementById('promptModal');
        const loginSection = document.getElementById('loginSection');
        const settingsSection = document.getElementById('settingsSection');
        
        const adminPassInput = document.getElementById('adminPassInput');
        const loginBtn = document.getElementById('loginBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        
        const promptInput = document.getElementById('promptInput');
        const savePromptBtn = document.getElementById('savePromptBtn');

        // --- UPDATED DEFAULT PROMPT (INTERNAL LOGIC) ---
        // Hidden from user UI, but enables the AI to handle Bangla queries
        let currentPrompt = "You are a friendly and professional English Tutor named LAGmate. 1. Primarily speak in English to help the user practice. 2. You UNDERSTAND Bengali (Bangla). If the user asks a question in Bangla (even phonetically), answer it naturally. 3. If the user asks for a meaning (e.g., 'What is this in Bangla?'), explain in Bangla. 4. Keep your responses concise (2-3 sentences) and encouraging.";
        
        promptInput.value = currentPrompt;

        // --- LOGIN LOGIC ---
        const ADMIN_PASS = "MIRAZLAGMATE@@"; 

        openSettings.onclick = () => {
            // Reset to Login View
            loginSection.style.display = 'block';
            settingsSection.style.display = 'none';
            adminPassInput.value = ""; 
            promptModal.classList.add('active');
        };

        loginBtn.onclick = () => {
            if(adminPassInput.value === ADMIN_PASS) {
                // Success: Show Settings
                loginSection.style.display = 'none';
                settingsSection.style.display = 'block';
            } else {
                // Fail
                adminPassInput.style.borderColor = 'red';
                setTimeout(() => adminPassInput.style.borderColor = 'rgba(255, 255, 255, 0.1)', 1000);
            }
        };

        cancelBtn.onclick = () => {
            promptModal.classList.remove('active');
        };

        savePromptBtn.onclick = () => {
            currentPrompt = promptInput.value;
            promptModal.classList.remove('active');
            aiTxt.innerText = "System Core Updated Successfully.";
        };
        // --------------------------------

        const SESSION_ID = "user_" + Math.random().toString(36).substr(2, 9);
        let isBusy = false;

        closeModal.onclick = () => welcomeModal.classList.add('hidden');
        function updateState(state) { orb.className = "orb " + state; }

        async function streamType(text, element) {
            element.innerHTML = "";
            const words = text.split(" ");
            let currentHTML = "";
            for (let word of words) {
                currentHTML += word + " ";
                element.innerHTML = currentHTML;
                transcriptBox.scrollTop = transcriptBox.scrollHeight;
                await new Promise(r => setTimeout(r, 40));
            }
        }

        async function setupDevices() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const devices = await navigator.mediaDevices.enumerateDevices();
                const inputs = devices.filter(d => d.kind === "audioinput");
                micSelect.innerHTML = inputs.map(m => `<option value="${m.deviceId}">${m.label || "Mic " + m.deviceId.slice(0,5)}</option>`).join("");
                stream.getTracks().forEach(track => track.stop());
            } catch (e) {
                micSelect.innerHTML = `<option>Mic Access Denied</option>`;
            }
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const rec = new SpeechRecognition();
            rec.interimResults = true;
            rec.lang = 'en-US'; 

            rec.onstart = () => { 
                updateState("listening"); 
                fluencyMeter.innerText = "LISTENING"; 
            };
            
            // --- NEW: Handle Errors ---
            rec.onerror = (event) => {
                console.log("Mic Error: " + event.error);
                if(event.error === 'no-speech') {
                    // Ignore no-speech and keep listening state visually
                    // It will trigger onend, where we restart
                } else {
                     // Real error
                     aiTxt.innerText = "Mic Issue: " + event.error + ". Trying to restart...";
                }
            };

            rec.onresult = e => {
                const text = Array.from(e.results).map(r => r[0].transcript).join('');
                userTxt.innerText = text;
                transcriptBox.scrollTop = transcriptBox.scrollHeight;
                if (e.results[0].isFinal) { 
                    rec.stop(); 
                    processTranscript(text); 
                }
            };

            rec.onend = () => { 
                if (!isBusy) {
                    // --- FIX: Add Delay before restarting to prevent crash ---
                    setTimeout(() => {
                        try { rec.start(); } catch(e) {}
                    }, 300);
                }
            };

            async function processTranscript(text) {
                if(!text.trim() || isBusy) return;
                
                isBusy = true; 
                updateState("thinking"); 
                fluencyMeter.innerText = "THINKING";
                
                try {
                    const res = await fetch(BACKEND_URL, {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ 
                            text: text,
                            session_id: SESSION_ID,
                            system_instruction: currentPrompt
                        })
                    });
                    const data = await res.json();
                    
                    if (data.audio) {
                        const audio = new Audio("data:audio/mpeg;base64," + data.audio);
                        updateState("speaking");
                        fluencyMeter.innerText = "SPEAKING";
                        audio.play();
                        await streamType(data.reply, aiTxt);
                        
                        audio.onended = () => {
                            isBusy = false; 
                            userTxt.innerText = "";
                            updateState("listening"); 
                            fluencyMeter.innerText = "LISTENING";
                            rec.start(); // Restart after speaking
                        };
                    } else {
                        await streamType(data.reply, aiTxt);
                        isBusy = false; 
                        rec.start();
                    }
                } catch (err) {
                    aiTxt.innerText = "Error. Backend offline?";
                    console.error(err);
                    isBusy = false; 
                    setTimeout(() => rec.start(), 2000);
                }
            }

            startBtn.onclick = () => { 
                uiPanel.classList.add('hidden'); 
                rec.start(); 
            };
        }

        window.onload = setupDevices;
    </script>
</body>
</html>
